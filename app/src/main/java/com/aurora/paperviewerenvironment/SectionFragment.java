package com.aurora.paperviewerenvironment;

import android.graphics.Color;
import android.graphics.Rect;
import android.os.Bundle;
import android.support.v4.app.Fragment;
import android.support.v4.view.ViewPager;
import android.view.LayoutInflater;
import android.view.View;
import android.view.ViewGroup;
import android.webkit.WebView;
import android.widget.ImageButton;
import android.widget.ScrollView;
import android.widget.TextView;

import com.aurora.paperviewerprocessor.paper.Paper;
import com.aurora.paperviewerprocessor.paper.Section;

/**
 * A fragment containing the view for a section of the paper
 */
public class SectionFragment extends Fragment implements View.OnClickListener {
    /*
     * The fragment argument representing the section number for this
     * fragment.
     */
    private static final String ARG_SECTION_INDEX = "section_number";

    private Paper mPaper;

    // Text area's for displaying the content from the section
    private TextView mSectionHeader;
    private WebView mSectionWebView;

    // Button's for navigating to other sections and the abstract
    private ImageButton mBtnTopNavLeft;
    private ImageButton mBtnTopNavRight;
    private ImageButton mBtnBottomNavLeft;
    private ImageButton mBtnBottomNavRight;

    public SectionFragment() {
        // Empty constructor (generated by Android Studio)
    }

    /**
     * Returns a new instance of this fragment for the given section
     * number.
     */
    public static SectionFragment newInstance(int sectionIndex) {
        SectionFragment fragment = new SectionFragment();
        Bundle args = new Bundle();
        args.putInt(ARG_SECTION_INDEX, sectionIndex);
        fragment.setArguments(args);
        return fragment;
    }

    public void setPaper(Paper paper){
        this.mPaper = paper;
    }

    @Override
    public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
        int sectionIndex = getArguments().getInt(ARG_SECTION_INDEX);
        Section section = mPaper.getSections().get(sectionIndex);

        // Inflate the scrollable view for a section
        View sectionView = inflater.inflate(R.layout.fragment_section, container, false);

        // TODO this doesn't seem to fix the initial position problem
        // Set the initial position to the start of the abstract
        ((ScrollView)sectionView.getRootView()).scrollTo(0,0);

        mSectionHeader = sectionView.findViewById(R.id.section_header);
        mSectionHeader.setText(section.getHeader());

        // Initialize navigation buttons
        mBtnTopNavLeft = sectionView.findViewById(R.id.btn_section_top_nav_left);
        mBtnBottomNavLeft = sectionView.findViewById(R.id.btn_section_bottom_nav_left);
        mBtnTopNavRight = sectionView.findViewById(R.id.btn_section_top_nav_right);
        mBtnBottomNavRight = sectionView.findViewById(R.id.btn_section_bottom_nav_right);
        mBtnTopNavLeft.setOnClickListener(this);
        mBtnBottomNavLeft.setOnClickListener(this);
        mBtnTopNavRight.setOnClickListener(this);
        mBtnBottomNavRight.setOnClickListener(this);
        if(canNavigateLeft(sectionIndex)){
            mBtnTopNavLeft.setVisibility(View.VISIBLE);
            mBtnBottomNavLeft.setVisibility(View.VISIBLE);
        }
        else{
            mBtnTopNavLeft.setVisibility(View.INVISIBLE);
            mBtnBottomNavLeft.setVisibility(View.INVISIBLE);
        }
        if(canNavigateRight(sectionIndex)){
            mBtnTopNavRight.setVisibility(View.VISIBLE);
            mBtnBottomNavRight.setVisibility(View.VISIBLE);
        }
        else{
            mBtnTopNavRight.setVisibility(View.INVISIBLE);
            mBtnBottomNavRight.setVisibility(View.INVISIBLE);
        }

        mSectionWebView = sectionView.findViewById(R.id.section_webview);
        mSectionWebView.setFocusable(false);
        mSectionWebView.setBackgroundColor(Color.TRANSPARENT);

        // Make buttons at the bottom invisible if they are part of the initial screen
        if(isVisibleInScrollView(((ScrollView) sectionView.getRootView()), mBtnBottomNavLeft)){
            mBtnBottomNavLeft.setVisibility(View.INVISIBLE);
        }

        if(isVisibleInScrollView(((ScrollView) sectionView.getRootView()), mBtnBottomNavRight)){
            mBtnBottomNavRight.setVisibility(View.INVISIBLE);
        }
        // TODO remove buttons at the bottom of scrollview if text smaller than window size
        // having them at the bottom for short text seems weird

        // Set the text properties of the section content
        String htmlFront = "<html><head>" +
                "<style type=\"text/css\">body {" +
                "font-family: " + getResources().getString(R.string.section_font_family) + ";" +
                "font-size: " + getResources().getDimension(R.dimen.section_font_size) + ";" +
                "font-weight: " + getResources().getString(R.string.section_font_weight) + ";" +
                "text-align: " + getResources().getString(R.string.section_text_align) + ";" +
                "}</style></head><body>";
        String htmlEnd = "</body></html>";
        String myHtmlString = htmlFront + section.getContent() + htmlEnd;

        // Add content to the webview
        mSectionWebView.loadDataWithBaseURL(null, myHtmlString, "text/html", "UTF-8", null);

        return sectionView;
    }

    @Override
    public void onClick(View view) {
        int sectionIndex = getArguments().getInt(ARG_SECTION_INDEX);
        ViewPager sectionViewPager = ((MainActivity) getActivity()).getSectionViewPager();

        switch(view.getId()){
            case R.id.btn_section_top_nav_left:
            case R.id.btn_section_bottom_nav_left:
                if(canNavigateLeft(sectionIndex)) {
                    System.out.println("(" + sectionViewPager.hashCode() + ")" + " click left, navigation to section: " + prevSectionPosition(sectionIndex));
                    sectionViewPager.setCurrentItem(prevSectionPosition(sectionIndex));
                }
                break;
            case R.id.btn_section_top_nav_right:
            case R.id.btn_section_bottom_nav_right:
                if(canNavigateRight(sectionIndex)) {
                    sectionViewPager.setCurrentItem(nextSectionPosition(sectionIndex));
                }
                break;
        }
    }

    private boolean canNavigateLeft(int currSectionIndex){
        return (currSectionIndex > 0 || (currSectionIndex == 0 & mPaper.getAbstract() != null));
    }

    private boolean canNavigateRight(int currSectionIndex){
        return currSectionIndex < (mPaper.getSections().size()-1);
    }

    /*
     * Returns the position of the next section in the section viewport
     * */
    private int nextSectionPosition(int currSectionIndex){
        if(mPaper.getAbstract() != null){
            // add 1 extra for the abstract taking position 0 in the viewport
            return currSectionIndex+2;
        }
        else{
            return currSectionIndex+1;
        }
    }

    /*
     * Returns the position of the prev section in the section viewport
     * */
    private int prevSectionPosition(int currSectionIndex){
        if(mPaper.getAbstract() != null){
            // add 1 for the abstract taking position 0 in the viewport
            return currSectionIndex;
        }
        else{
            return currSectionIndex-1;
        }
    }

    /**
     *   Checks whether the given view is visible in the scroll view
     */
    private boolean isVisibleInScrollView(ScrollView scrollView, View view){
        Rect scrollBounds = new Rect();
        scrollView.getHitRect(scrollBounds);
        if (view.getLocalVisibleRect(scrollBounds)) {
            return true;
        }
        return false;
    }


}

